<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de sicrazão</title>

    <style>

    body {
        background-color: blue;
    }

    #caixa {
        float: right;
        
    

        
    }

    #agencia {
        margin-top: 10px;
        margin-bottom: 10px;
        background-color: white;
        }

    #resetar {
        margin-bottom: 10px;
    }

    #carrega{
        margin-bottom: 10px;
    }

    #totalMes{
        vertical-align: top;
        display: inline-block;        
        margin-right: 350px;
        padding: 1px;
        background-color: rgb(182, 245, 182);
        border: 3px ridge rgb(131, 131, 247);
        width: 220px
    }

    #cadaDiaMes {
        display: inline-block;
        background-color: rgb(182, 245, 182);
        border: 10px ridge rgb(131, 131, 247);
        border-radius: 10px 10px 10px 10px;
        width: 220px;
        padding-right: 2px;
        padding-left: 2px;
        height: 450px;
        width: 220px;
    }

    



    #csv2 {
        margin-top: 10px;
        background-color: rgb(245, 245, 117);
    }

    </style>



</head>
<body>

    <form id="formulario">

        <div class="blue">
            Agência com quatro dígitos:<input type="Text" id="agencia"   maxlength=4 size= 1>
        </div>

        <div class="blue"> 
            <input type="reset" value="Reset para nova operação" id="resetar"> Selecione o botão caso necessário outro carregamento</input>
        </div>

        <div class="blue">
            Sicrazão .txt a ser lido:<input type="file" id="carrega">
        </div>
        
        <div id="totalMes" class="linha" >Total para o mês: 0

        </div>

        <div id="cadaDiaMes" id="cadaDiaMes2" class="linha" > Total por dias para o mês:

        </div>

        <img src="https://www.caixa.gov.br/PublishingImages/01_Destaques.png" width="500" height="465" id="caixa">

        <div id="csv"> 
            <input type="button" value="Gerar .csv" id="csv2"> Selecione o botão caso necessite gerar .csv</input>
        </div>

        

    </form>
    
    <script>
        var arquivo = new FileReader();  // cria instância de objeto leitor
        var arquivoLido  = document.getElementById("carrega");

        var agencia = document.getElementById("agencia");
        agencia.onchange = function () {
                agenciaDefinida = agencia.value;
                console.log (agenciaDefinida);
        }        
        quadroMes = ""
        quadroTotal= ""
        arquivoLido.onchange = function (event) { 
            console.log(arquivoLido); // elemento html p JS bruto
            arquivoLido = arquivoLido.files[0]; // quando "change", seleciona o arquivo
            console.log(arquivoLido); // arquivo já selecionado corretamente
            console.log(arquivo); // estado atual do objeto leitor sem ler nada
            arquivo.readAsText(arquivoLido); // lê arquivo como string e entrega p/ result
            arquivo.onload = function (event) {
                console.log(arquivo.result); // propriedade do objeto leitor com resultado string
                console.log(arquivo); // estado atual do obj leitor com leitura já completa por aguard load > readyState 2
                
                
            

                //var agenciaMovimento = /\s\d{2}\s2908\s\d{4}\s.+/g; // pesquisa das linhas da agência de movimento 2908 seria assim em pesq literal
                var agenciaMovimento = "\\s\\d{2}\\sTROCAR\\s\\d{4}\\s.+"; // defino uma string para alteração
                agenciaMovimento = agenciaMovimento.replace ("TROCAR", agenciaDefinida); // altero a string para campo definido pelo usuário
                agenciaMovimento = new RegExp(agenciaMovimento,"g");
                console.log (agenciaMovimento); // mostra regexp correta

                var linhasAgMov; // será objeto com várias informações por pequisa do while-exec
                var arr2 = []; // será array com objeto das linhas das ags de mov (tirei arr1)
                while (linhasAgMov = agenciaMovimento.exec(arquivo.result)) {// vai pesquisando linhas com ag de movimento

                    console.log(linhasAgMov);
                    console.log(typeof(linhasAgMov)); // mostra objeto com várias informações
                    arr2.push(linhasAgMov); // vai acrescentando em um array
                    console.log(arr2);
                }

                console.log("terminei de procurar linhas"); // para saber que terminou de pesquisar por linhas da ag de mov

                dataProcurada = /\sMOV:\s\d{2}\/(\d{2})\/(\d{4})/ //capturará mês e ano
                dataMovimento = dataProcurada.exec(arquivo.result); // procura a 1ª data de mov
                console.log(dataMovimento); // mostra objeto com várias informações, dentre elas mês e ano

                

                x = 0; // contrador genérico
                var multiplicador; // definirá se valor é credor ou devedor
                var valorReal;
                var todosNumeros = []; // array com todos os números p JS com sinal + ou -. Linha 202

                // variáveis abaixo são os campos da linha
                var DD
                var MOV
                var UNID
                var SIST
                var ROT
                var NDOC
                var DATA_EFETIVA
                var EVENTO
                var SL
                var PROD
                var ANALITICO
                var VALOR // valor original do campo
                var VALOR2 // valor original acertado em ponto, em vírgula e em casas decimais em 3 processos sequenciais p/ JS
                var VALOR3 // valor2 acertado com sinal correto pelo multiplicador e em casas decimais 
                //linhas =[]
                var linhasString = []
                datasTotal = [] // array com todas dataAcertada (datas) 
                datasDias =[] // array com todas DD (dias em número)


                //while percorrerá arr2 e cada elemento de índice 0 traz as linhas
                //capturará cada campo na variável

                while (x<arr2.length) {
                    
                    DD = arr2[x][0].substring(1,3)
                    MOV = arr2[x][0].substring(4,8)
                    UNID = arr2[x][0].substring(9,13)
                    SIST = arr2[x][0].substring(14,18)
                    ROT = arr2[x][0].substring(19,22)
                    NDOC = arr2[x][0].substring(23,27)
                    DATA_EFETIVA = arr2[x][0].substring(28,38)
                    EVENTO = arr2[x][0].substring(39,44)
                    SL = arr2[x][0].substring(47,48)
                    PROD = arr2[x][0].substring(50,54)
                    VALOR = arr2[x][0].substring(55,)
                    VALOR2 = VALOR.replace(".","");
                    VALOR2 = VALOR2.replace(",",".");
                    VALOR2 = parseFloat(VALOR2).toFixed(2)
                    dataAcertada = DD+"/"+dataMovimento[1]+"/"+dataMovimento[2] // data com DD/MM/AAAA

                    //dependendo do tamanho da linha, sei se o valor é credor ou devedor
                    //multiplicador será definido para ajuste do valor, se credor ou devedor
                    //em caso de alteração do tamanho da linha, coloquei aviso ao DEV
        
                    if (arr2[x][0].length===93) {
                        multiplicador = -1
                    } else if (arr2[x][0].length===117) {
                        multiplicador = 1
                    } else { console.log ("Temos problema no tamanho da String da linha")
                    }

                    console.log(multiplicador) // mostra se credor ou devedor

                    VALOR3 = (VALOR2*multiplicador).toFixed(2)
                    
                    VALOR4 = VALOR3.replace(".",",") // valor3 volta a configuração entendível para uso na linha 178 - JS usa ponto ao invés de vírgula

                    
                    
                    // para formar .csv
                    linhaString = "<br>" + dataAcertada + ";" + MOV + ";" + UNID + ";" + SIST + ";" + ROT + ";"
                        + NDOC + ";" + DATA_EFETIVA + ";" + EVENTO + ";" + SL + ";" + PROD + ";" + VALOR4


                    
                    
                    // para formar .csv
                    linhasString += linhaString


                    valorReal = VALOR2*multiplicador // comentando depois de feito o código acho que poderia ter usado valor3, não vou mexer
                    todosNumeros.push(valorReal)

                    
                    datasTotal.push(dataAcertada)
                    DD = Number(DD) // transforma DD string para número
                    datasDias.push(DD)
                  

                    x++
                }

                console.log(todosNumeros)
                console.log(datasDias)


                    
                sum = 0    // somatório zerado
                todosNumeros.forEach(function(value){ sum+=value; return sum;})
                sum = parseFloat(sum.toFixed(2));
                console.log(sum);  // mostra no cosole o somatório do mês
                somaDoMes = document.getElementById("totalMes");
                somaDoMes.textContent = "Total para o mês: " + sum; //mostra na div o somatório do mês



                

                

                ZZ=0
                //cont = 1
                somaData = 0
                B=0 // contador genérico
                W=0
                WB=0
                i=0
                arrDeIndices =[] // ARRAY QUE AGRUPA arrays de 0 a 31 correspondente aos dias dos mês. Arrays de 0 a 31 serão preenchidos com índices com elemento de valor idêntico no dataDias. "nº do array arrDeIndices = índices com elementos de valor idêntico no array dataDias"
                somaNovo = [] // ARRAY QUE AGRUPA Arrays com o resultado da soma do dia
                presenteOuAusente =[] // array com 32 posições indicando se dia presente ou ausente



                while (B<32) { // insere nos arrays elementos "vazios"
                    
                
                    somaNovo.push(somaNovo[B])
                    somaNovo[B]=0
                    arrDeIndices.push(arrDeIndices[B])
                    arrDeIndices[B]=[]
                    presenteOuAusente.push(presenteOuAusente[B])
                    presenteOuAusente[B]=0


                

                    B++
                }

                console.log(arrDeIndices) // mostra array com elementos arrays os quais tem como elementos os índices das datas no array datasDias que coincide no "nº do array filho daqui"

                B=0 // zerei o contador novamente para não ter que criar outro > já utilizado em linha 206
                var cont = 0 // contador genérico

                while (cont<32) {
                    while (B<datasDias.length) { // B é o índice dos elementos referentes a pesquisa em array com todas os dias DD
                        B = datasDias.indexOf(cont, B)// retorna índice do elemento encontrado. Valor proc é de 0 a 31 "dias do mês"/cont. Começa pesq na pos 0/B. Índice gravado é o da pos enc para uma data cont
                        if (B ===-1) break // se não acha, passa para o contador cont=DIAS seguinte
                        arrDeIndices[cont].push(B) // guarda índices das posições para cada array referente a data do mês - de 0 a 31
                        
                        
                        B++ // incremento habitual para while interior
                        
                            
                    }
                    B = 0 //devo zerar o contador=POSIÇÃO para outra pesquisa do cont
                    cont++ // incremento habitual para while exterior
                }

            

                cont = 0 // zerei contador para não ter que criar novo
                while(cont<32){
                    console.log(cont+"="+arrDeIndices[cont]) // mostrará o mesmo que linha 232
                    
                    cont++
                }
                //Parei por aqui HJ!
                cont = 0 // zerei contador para não ter que criar novo
                somaDiaDoMES = 0 // soma dia do mês
                cont2 = 0 // contador genérico


                while (cont2<32) {
                    while (cont<arrDeIndices[cont2].length) {

                        valorIndice = arrDeIndices[cont2][cont] // pega valorIndice. O arrDeIndices[1] é o dia 01 do mês com os elementos com valor da posição para o dia equiv no dataDias
                        somaDiaDoMES += todosNumeros[valorIndice] // soma para cada dia do mês o total. Valor será transferido
                        console.log(somaDiaDoMES.toFixed(2)) 
                        cont++ // incremento normal no while interno
                    }

                    somaNovo[cont2] = somaDiaDoMES.toFixed(2) // transfere resultado da soma do dia para array correspondente a soma do dia p/ o mês
                    //debugger
                    somaDiaDoMES = 0 // zerado para cálculo do novo dia
                    cont2++ // incremento normal no while externo
                    cont = 0 // zerado para cálculo do novo dia
                }

                contador = 0
                dias = 0
                while (dias<32) {

                    while (contador<datasDias.length) { // definirá variável que indicará se soma do dia deve ser exibida. Exs: dia 0 nunca existirá, dia 05 pode ter sido FDS
                        ZZ = datasDias[contador] == dias // para descobrir se dias existem nos dias fantasia de 0 a 31
                                                
                        if (ZZ) { 
                            presenteOuAusente[dias] = true; break; // se verdadeiro, já define variável como verdadeira e parte p/ próx dia
                        } else {
                            presenteOuAusente[dias] = false }
                        
                        contador++ // incremento referente ao tamanho do array
                        



                        

                    }
                                                
                    contador =0 // contador zerado para pesquisa do próximo dia
                    dias++ // incremento normal para pesquisa do próximo dia

                }

                console.log(presenteOuAusente) // mostra se dia - a posição do elemento seria o valor dia - presente ou ausente 



                cont2 = 0 // zerei contador para evitar a criação de um novo
                
                diaDoMes = document.getElementById("cadaDiaMes")

                while (cont2<32) { 

                    
                    if (presenteOuAusente[cont2]) {
                        console.log(cont2+"= "+somaNovo[cont2]) // se dia presente, mostra o dia e soma do dia
                        
                        quadroMes = cont2 + "= " +somaNovo[cont2] +"<br>"// soma do dia
                        
                        
                    }
                    
                        quadroTotal += quadroMes // transfiro para quadro geral
                        quadroMes = "" // zero quadro transitório
                    
                    cont2++
                    
                    
                }

                diaDoMes.innerHTML = "Total por dia para o mês: " + dataMovimento[1]+"/"+dataMovimento[2] + "<br>" +  "<br>" +  quadroTotal;
                console.log(quadroTotal);
                    
                    
                var csv = document.getElementById("csv"); 
                var csv2 = document.getElementById("csv2"); 
                csv2.onclick = function () {
                    csv.innerHTML=  "Dt Movimento;Unidade Movimento;Unidade Origem;Sistema;Rotina;NDOC;Data Efetiva;Evento;SL;Produto;Valor"  + linhasString // cabeçalho + conteúdo
                   
                }
                console.log(todosNumeros)
                console.log(datasTotal)

                
                var resetar = document.getElementById("resetar"); 
                
                resetar.onclick = function () {
                    document.location.reload(); // além de só limpar o campo da ag, dá um refresh
                }

                
            }
            
        
        }
        
        
    </script>

</body>
</html>

